//@version=6
indicator("Elliott Wave CONFLUENCE", overlay=true, max_labels_count=200, max_lines_count=200)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ¯ CONFLUENCE SYSTEM - Score-based signals
// Each condition = 1 point. Signal when score >= threshold
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

grp_score = "ğŸ¯ SCORING SYSTEM"
min_score = input.int(6, "Min Score for Signal", minval=3, maxval=10, group=grp_score, tooltip="Signal fires when this many conditions are met")
show_score = input.bool(true, "Show Score on Signal", group=grp_score)

grp_zz = "ğŸ”€ ZIGZAG"
zz_depth = input.int(12, "Depth", minval=5, maxval=30, group=grp_zz)
zz_dev = input.float(2.0, "Deviation %", group=grp_zz)

grp_ew = "ğŸŒŠ ELLIOTT WAVE"
w2_min = input.float(0.382, "Wave 2 Min", group=grp_ew)
w2_max = input.float(0.786, "Wave 2 Max", group=grp_ew)
min_wave = input.float(1.5, "Min Wave Size %", group=grp_ew)

grp_ind = "ğŸ“Š INDICATORS (Toggle On/Off)"
use_ema_fast = input.bool(true, "1. EMA Fast (20)", group=grp_ind)
use_ema_slow = input.bool(true, "2. EMA Slow (50)", group=grp_ind)
use_ema_trend = input.bool(true, "3. EMA Trend (200)", group=grp_ind)
use_rsi = input.bool(true, "4. RSI (not overbought)", group=grp_ind)
use_macd = input.bool(true, "5. MACD (bullish)", group=grp_ind)
use_momentum = input.bool(true, "6. Momentum (positive)", group=grp_ind)
use_volume = input.bool(true, "7. Volume (above avg)", group=grp_ind)
use_bb = input.bool(true, "8. Bollinger (near lower)", group=grp_ind)
use_stoch = input.bool(true, "9. Stochastic (oversold)", group=grp_ind)
use_adx = input.bool(true, "10. ADX (trending)", group=grp_ind)

grp_params = "âš™ï¸ INDICATOR PARAMS"
ema_fast_len = input.int(20, "EMA Fast", group=grp_params)
ema_slow_len = input.int(50, "EMA Slow", group=grp_params)
ema_trend_len = input.int(200, "EMA Trend", group=grp_params)
rsi_len = input.int(14, "RSI Length", group=grp_params)
rsi_ob = input.int(65, "RSI Overbought", group=grp_params)
bb_len = input.int(20, "BB Length", group=grp_params)
bb_mult = input.float(2.0, "BB Mult", group=grp_params)
stoch_k = input.int(14, "Stoch K", group=grp_params)
stoch_os = input.int(30, "Stoch Oversold", group=grp_params)
adx_len = input.int(14, "ADX Length", group=grp_params)
adx_min = input.int(20, "ADX Min (trending)", group=grp_params)
vol_avg_len = input.int(20, "Volume Avg Length", group=grp_params)

grp_tp = "ğŸ’° TARGETS"
tp_fib = input.float(1.618, "Take Profit Fib", group=grp_tp)
sl_pct = input.float(2.5, "Stop Loss %", group=grp_tp)
min_bars = input.int(8, "Min Bars Between", group=grp_tp)

grp_vis = "ğŸ‘ VISUALS"
show_zz = input.bool(true, "Zigzag", group=grp_vis)
show_emas = input.bool(true, "EMAs", group=grp_vis)
show_stats = input.bool(true, "Stats Table", group=grp_vis)
show_conditions = input.bool(true, "Conditions Table", group=grp_vis)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CALCULATE ALL INDICATORS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// EMAs
ema_f = ta.ema(close, ema_fast_len)
ema_s = ta.ema(close, ema_slow_len)
ema_t = ta.ema(close, ema_trend_len)

// RSI
rsi = ta.rsi(close, rsi_len)

// MACD
[macd_line, signal_line, hist] = ta.macd(close, 12, 26, 9)

// Momentum
mom = ta.mom(close, 10)

// Volume
vol_avg = ta.sma(volume, vol_avg_len)

// Bollinger Bands
bb_basis = ta.sma(close, bb_len)
bb_dev = bb_mult * ta.stdev(close, bb_len)
bb_upper = bb_basis + bb_dev
bb_lower = bb_basis - bb_dev

// Stochastic
stoch = ta.stoch(close, high, low, stoch_k)

// ADX
[di_plus, di_minus, adx] = ta.dmi(adx_len, adx_len)

// Plot EMAs
plot(show_emas ? ema_f : na, "EMA Fast", color=color.new(color.yellow, 50), linewidth=1)
plot(show_emas ? ema_s : na, "EMA Slow", color=color.new(color.orange, 50), linewidth=1)
plot(show_emas ? ema_t : na, "EMA Trend", color=color.new(color.white, 50), linewidth=2)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONDITION CHECKS (each returns 1 if true, 0 if false)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// 1. Price above fast EMA
cond1() => use_ema_fast ? (close > ema_f ? 1 : 0) : 0
cond1_max() => use_ema_fast ? 1 : 0

// 2. Price above slow EMA
cond2() => use_ema_slow ? (close > ema_s ? 1 : 0) : 0
cond2_max() => use_ema_slow ? 1 : 0

// 3. Price above trend EMA (200)
cond3() => use_ema_trend ? (close > ema_t ? 1 : 0) : 0
cond3_max() => use_ema_trend ? 1 : 0

// 4. RSI not overbought
cond4() => use_rsi ? (rsi < rsi_ob ? 1 : 0) : 0
cond4_max() => use_rsi ? 1 : 0

// 5. MACD bullish (histogram positive or line > signal)
cond5() => use_macd ? (macd_line > signal_line ? 1 : 0) : 0
cond5_max() => use_macd ? 1 : 0

// 6. Momentum positive
cond6() => use_momentum ? (mom > 0 ? 1 : 0) : 0
cond6_max() => use_momentum ? 1 : 0

// 7. Volume above average
cond7() => use_volume ? (volume > vol_avg ? 1 : 0) : 0
cond7_max() => use_volume ? 1 : 0

// 8. Price near lower Bollinger (good entry zone)
cond8() => use_bb ? (close < bb_basis ? 1 : 0) : 0
cond8_max() => use_bb ? 1 : 0

// 9. Stochastic oversold or rising from oversold
cond9() => use_stoch ? (stoch < stoch_os or (stoch < 50 and stoch > stoch[1]) ? 1 : 0) : 0
cond9_max() => use_stoch ? 1 : 0

// 10. ADX showing trend
cond10() => use_adx ? (adx > adx_min and di_plus > di_minus ? 1 : 0) : 0
cond10_max() => use_adx ? 1 : 0

// Calculate total score
getScore() =>
    cond1() + cond2() + cond3() + cond4() + cond5() + cond6() + cond7() + cond8() + cond9() + cond10()

getMaxScore() =>
    cond1_max() + cond2_max() + cond3_max() + cond4_max() + cond5_max() + cond6_max() + cond7_max() + cond8_max() + cond9_max() + cond10_max()

currentScore = getScore()
maxScore = getMaxScore()

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ZIGZAG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ph = ta.pivothigh(high, zz_depth, zz_depth)
pl = ta.pivotlow(low, zz_depth, zz_depth)

var float[] zzP = array.new_float(0)
var int[] zzB = array.new_int(0)
var int[] zzT = array.new_int(0)
var int dir = 0
var float lastP = 0.0

if not na(ph)
    pb = bar_index - zz_depth
    if dir <= 0
        if array.size(zzP) > 0 and dir == -1
            if math.abs(ph - lastP) / lastP * 100 >= zz_dev
                array.push(zzP, ph)
                array.push(zzB, pb)
                array.push(zzT, 1)
                dir := 1
                lastP := ph
        else if array.size(zzP) == 0
            array.push(zzP, ph)
            array.push(zzB, pb)
            array.push(zzT, 1)
            dir := 1
            lastP := ph
    else if dir == 1 and ph > lastP
        if array.size(zzP) > 0
            array.set(zzP, array.size(zzP) - 1, ph)
            array.set(zzB, array.size(zzB) - 1, pb)
            lastP := ph

if not na(pl)
    pb = bar_index - zz_depth
    if dir >= 0
        if array.size(zzP) > 0 and dir == 1
            if math.abs(pl - lastP) / lastP * 100 >= zz_dev
                array.push(zzP, pl)
                array.push(zzB, pb)
                array.push(zzT, -1)
                dir := -1
                lastP := pl
        else if array.size(zzP) == 0
            array.push(zzP, pl)
            array.push(zzB, pb)
            array.push(zzT, -1)
            dir := -1
            lastP := pl
    else if dir == -1 and pl < lastP
        if array.size(zzP) > 0
            array.set(zzP, array.size(zzP) - 1, pl)
            array.set(zzB, array.size(zzB) - 1, pb)
            lastP := pl

getPt(i) =>
    sz = array.size(zzP)
    if i < sz
        [array.get(zzP, sz-1-i), array.get(zzB, sz-1-i), array.get(zzT, sz-1-i)]
    else
        [0.0, 0, 0]

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WAVE DETECTION WITH CONFLUENCE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

detectWave() =>
    [p0, b0, t0] = getPt(0)
    [p1, b1, t1] = getPt(1)
    [p2, b2, t2] = getPt(2)
    
    sig = false
    entry = 0.0
    tp = 0.0
    sl = 0.0
    score = 0
    waveType = 0
    
    if p0 > 0 and p1 > 0 and p2 > 0
        if t2 == -1 and t1 == 1 and t0 == -1
            w1 = p1 - p2
            if w1 > 0 and (w1 / p2 * 100) >= min_wave
                ret = (p1 - p0) / w1
                if ret >= w2_min and ret <= w2_max
                    score := currentScore
                    if score >= min_score
                        sig := true
                        entry := p0
                        tp := p0 + (w1 * tp_fib)
                        sl := p0 * (1 - sl_pct / 100)
                        waveType := 3
    
    [sig, entry, tp, sl, score, waveType, b0]

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRACKING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var int[] sigB = array.new_int(0)
var float[] sigE = array.new_float(0)
var float[] sigTP = array.new_float(0)
var float[] sigSL = array.new_float(0)
var int[] sigR = array.new_int(0)

var int total = 0
var int wins = 0
var int losses = 0
var int lastSigBar = 0

[ws, we, wtp, wsl, wscore, wtype, wb] = detectWave()

var int lastWb = 0
if ws and wb != lastWb and (bar_index - lastSigBar) >= min_bars
    lastWb := wb
    lastSigBar := bar_index
    array.push(sigB, wb)
    array.push(sigE, we)
    array.push(sigTP, wtp)
    array.push(sigSL, wsl)
    array.push(sigR, 0)
    total += 1
    
    scoreColor = wscore >= 8 ? color.new(#00ff88, 0) : wscore >= 6 ? color.new(color.yellow, 0) : color.new(color.orange, 0)
    lbl = "ğŸ¯ BUY" + (show_score ? "\n" + str.tostring(wscore) + "/" + str.tostring(maxScore) : "")
    label.new(wb, we, lbl, style=label.style_label_up, color=scoreColor, textcolor=color.white, size=size.normal)
    line.new(wb, wtp, bar_index + 15, wtp, color=color.new(color.lime, 30), width=2)
    line.new(wb, wsl, bar_index + 15, wsl, color=color.new(color.red, 30), width=2)

// Backtest
if array.size(sigR) > 0
    for i = 0 to array.size(sigR) - 1
        if array.get(sigR, i) == 0
            if high >= array.get(sigTP, i)
                array.set(sigR, i, 1)
                wins += 1
            else if low <= array.get(sigSL, i)
                array.set(sigR, i, -1)
                losses += 1

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAW ZIGZAG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if show_zz and array.size(zzP) >= 2 and barstate.islast
    for i = 0 to math.min(array.size(zzP) - 2, 15)
        idx = array.size(zzP) - 1 - i
        if idx > 0 and bar_index - array.get(zzB, idx-1) < 500
            line.new(array.get(zzB, idx-1), array.get(zzP, idx-1), array.get(zzB, idx), array.get(zzP, idx), 
                     color=array.get(zzT, idx) == 1 ? color.lime : color.red, width=3)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONDITIONS TABLE (Live status)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if show_conditions
    var table condTbl = table.new(position.bottom_right, 2, 12, bgcolor=color.new(#1a1a2e, 10), border_width=1)
    
    table.cell(condTbl, 0, 0, "ğŸ“Š CONDITIONS", text_color=color.white, bgcolor=color.new(color.blue, 50), text_size=size.small)
    table.cell(condTbl, 1, 0, str.tostring(currentScore) + "/" + str.tostring(maxScore), text_color=currentScore >= min_score ? color.lime : color.orange, bgcolor=color.new(color.blue, 50), text_size=size.small)
    
    c1 = cond1() == 1
    c2 = cond2() == 1
    c3 = cond3() == 1
    c4 = cond4() == 1
    c5 = cond5() == 1
    c6 = cond6() == 1
    c7 = cond7() == 1
    c8 = cond8() == 1
    c9 = cond9() == 1
    c10 = cond10() == 1
    
    if use_ema_fast
        table.cell(condTbl, 0, 1, "EMA 20", text_color=color.gray, text_size=size.tiny)
        table.cell(condTbl, 1, 1, c1 ? "âœ…" : "âŒ", text_color=c1 ? color.lime : color.red, text_size=size.tiny)
    if use_ema_slow
        table.cell(condTbl, 0, 2, "EMA 50", text_color=color.gray, text_size=size.tiny)
        table.cell(condTbl, 1, 2, c2 ? "âœ…" : "âŒ", text_color=c2 ? color.lime : color.red, text_size=size.tiny)
    if use_ema_trend
        table.cell(condTbl, 0, 3, "EMA 200", text_color=color.gray, text_size=size.tiny)
        table.cell(condTbl, 1, 3, c3 ? "âœ…" : "âŒ", text_color=c3 ? color.lime : color.red, text_size=size.tiny)
    if use_rsi
        table.cell(condTbl, 0, 4, "RSI", text_color=color.gray, text_size=size.tiny)
        table.cell(condTbl, 1, 4, c4 ? "âœ…" : "âŒ", text_color=c4 ? color.lime : color.red, text_size=size.tiny)
    if use_macd
        table.cell(condTbl, 0, 5, "MACD", text_color=color.gray, text_size=size.tiny)
        table.cell(condTbl, 1, 5, c5 ? "âœ…" : "âŒ", text_color=c5 ? color.lime : color.red, text_size=size.tiny)
    if use_momentum
        table.cell(condTbl, 0, 6, "Momentum", text_color=color.gray, text_size=size.tiny)
        table.cell(condTbl, 1, 6, c6 ? "âœ…" : "âŒ", text_color=c6 ? color.lime : color.red, text_size=size.tiny)
    if use_volume
        table.cell(condTbl, 0, 7, "Volume", text_color=color.gray, text_size=size.tiny)
        table.cell(condTbl, 1, 7, c7 ? "âœ…" : "âŒ", text_color=c7 ? color.lime : color.red, text_size=size.tiny)
    if use_bb
        table.cell(condTbl, 0, 8, "Bollinger", text_color=color.gray, text_size=size.tiny)
        table.cell(condTbl, 1, 8, c8 ? "âœ…" : "âŒ", text_color=c8 ? color.lime : color.red, text_size=size.tiny)
    if use_stoch
        table.cell(condTbl, 0, 9, "Stochastic", text_color=color.gray, text_size=size.tiny)
        table.cell(condTbl, 1, 9, c9 ? "âœ…" : "âŒ", text_color=c9 ? color.lime : color.red, text_size=size.tiny)
    if use_adx
        table.cell(condTbl, 0, 10, "ADX", text_color=color.gray, text_size=size.tiny)
        table.cell(condTbl, 1, 10, c10 ? "âœ…" : "âŒ", text_color=c10 ? color.lime : color.red, text_size=size.tiny)
    
    table.cell(condTbl, 0, 11, "Min Score", text_color=color.white, text_size=size.tiny)
    table.cell(condTbl, 1, 11, str.tostring(min_score), text_color=color.yellow, text_size=size.tiny)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATS TABLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if show_stats
    var table tbl = table.new(position.top_right, 2, 6, bgcolor=color.new(#0d1117, 5), border_width=2)
    
    closed = wins + losses
    rate = closed > 0 ? (wins * 100.0 / closed) : 0.0
    rateCol = rate >= 80 ? #00ff88 : rate >= 60 ? color.yellow : color.red
    
    table.cell(tbl, 0, 0, "ğŸ”— CONFLUENCE", text_color=#00ccff, bgcolor=color.new(#0066cc, 50), text_size=size.normal)
    table.cell(tbl, 1, 0, timeframe.period, text_color=color.yellow, bgcolor=color.new(#0066cc, 50), text_size=size.normal)
    
    table.cell(tbl, 0, 1, "Signals", text_color=color.white, text_size=size.small)
    table.cell(tbl, 1, 1, str.tostring(total), text_color=color.white, text_size=size.small)
    
    table.cell(tbl, 0, 2, "âœ… Wins", text_color=color.lime, text_size=size.small)
    table.cell(tbl, 1, 2, str.tostring(wins), text_color=color.lime, text_size=size.small)
    
    table.cell(tbl, 0, 3, "âŒ Losses", text_color=color.red, text_size=size.small)
    table.cell(tbl, 1, 3, str.tostring(losses), text_color=color.red, text_size=size.small)
    
    table.cell(tbl, 0, 4, "â³ Open", text_color=color.orange, text_size=size.small)
    table.cell(tbl, 1, 4, str.tostring(total - closed), text_color=color.orange, text_size=size.small)
    
    table.cell(tbl, 0, 5, "ğŸ† WIN RATE", text_color=color.white, bgcolor=color.new(rateCol, 70), text_size=size.normal)
    table.cell(tbl, 1, 5, str.tostring(rate, "#.#") + "%", text_color=rateCol, bgcolor=color.new(rateCol, 70), text_size=size.large)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ALERTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

alertcondition(ws, "Confluence Signal", "ğŸ”— Elliott Confluence: BUY Signal!")
