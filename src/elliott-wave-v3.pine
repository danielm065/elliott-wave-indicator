//@version=6
indicator("Elliott Wave Pro", overlay=true, max_labels_count=500, max_lines_count=500)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INPUTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

grp_zz = "ğŸ”€ ZIGZAG"
zz_depth = input.int(10, "Depth", minval=5, maxval=30, group=grp_zz)
zz_dev = input.float(3.0, "Deviation %", minval=1.0, maxval=10.0, group=grp_zz)

grp_ew = "ğŸŒŠ ELLIOTT WAVE"
w2_min = input.float(0.5, "Wave 2 Min Retrace", minval=0.3, maxval=0.7, step=0.05, group=grp_ew)
w2_max = input.float(0.786, "Wave 2 Max Retrace", minval=0.6, maxval=0.95, step=0.05, group=grp_ew)
w4_min = input.float(0.236, "Wave 4 Min Retrace", minval=0.15, maxval=0.4, step=0.05, group=grp_ew)
w4_max = input.float(0.5, "Wave 4 Max Retrace", minval=0.35, maxval=0.6, step=0.05, group=grp_ew)
min_wave_pct = input.float(2.0, "Min Wave Size %", minval=0.5, maxval=10.0, group=grp_ew, tooltip="Minimum wave 1 size as % of price")

grp_filter = "ğŸ¯ FILTERS"
use_trend = input.bool(true, "Use Trend Filter", group=grp_filter)
trend_ema = input.int(50, "Trend EMA Length", minval=10, maxval=200, group=grp_filter)
min_bars_between = input.int(5, "Min Bars Between Signals", minval=1, maxval=20, group=grp_filter)

grp_tp = "ğŸ’° TARGETS"
tp_fib = input.float(1.618, "Take Profit (Fib)", minval=1.0, maxval=3.0, step=0.1, group=grp_tp)
sl_pct = input.float(3.0, "Stop Loss %", minval=1.0, maxval=10.0, step=0.5, group=grp_tp)

grp_vis = "ğŸ‘ VISUALS"
zz_color = input.color(color.new(color.blue, 0), "Zigzag Color", group=grp_vis)
zz_width = input.int(3, "Zigzag Width", minval=1, maxval=5, group=grp_vis)
bull_color = input.color(color.new(color.green, 0), "Buy Signal Color", group=grp_vis)
show_zz = input.bool(true, "Show Zigzag", group=grp_vis)
show_labels = input.bool(true, "Show Labels", group=grp_vis)
show_tp_sl = input.bool(true, "Show TP/SL Lines", group=grp_vis)
show_stats = input.bool(true, "Show Stats", group=grp_vis)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TREND FILTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ema_val = ta.ema(close, trend_ema)
uptrend = close > ema_val
plot(use_trend ? ema_val : na, "Trend EMA", color=color.new(color.orange, 50), linewidth=2)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ZIGZAG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ph = ta.pivothigh(high, zz_depth, zz_depth)
pl = ta.pivotlow(low, zz_depth, zz_depth)

var float[] zzP = array.new_float(0)
var int[] zzB = array.new_int(0)
var int[] zzT = array.new_int(0)  // 1=high, -1=low

var int dir = 0
var float lastP = 0.0
var int lastB = 0

if not na(ph)
    pb = bar_index - zz_depth
    if dir <= 0
        if array.size(zzP) > 0 and dir == -1
            pct = math.abs(ph - lastP) / lastP * 100
            if pct >= zz_dev
                array.push(zzP, ph)
                array.push(zzB, pb)
                array.push(zzT, 1)
                dir := 1
                lastP := ph
                lastB := pb
        else if array.size(zzP) == 0
            array.push(zzP, ph)
            array.push(zzB, pb)
            array.push(zzT, 1)
            dir := 1
            lastP := ph
            lastB := pb
    else if dir == 1 and ph > lastP
        if array.size(zzP) > 0
            array.set(zzP, array.size(zzP) - 1, ph)
            array.set(zzB, array.size(zzB) - 1, pb)
            lastP := ph
            lastB := pb

if not na(pl)
    pb = bar_index - zz_depth
    if dir >= 0
        if array.size(zzP) > 0 and dir == 1
            pct = math.abs(pl - lastP) / lastP * 100
            if pct >= zz_dev
                array.push(zzP, pl)
                array.push(zzB, pb)
                array.push(zzT, -1)
                dir := -1
                lastP := pl
                lastB := pb
        else if array.size(zzP) == 0
            array.push(zzP, pl)
            array.push(zzB, pb)
            array.push(zzT, -1)
            dir := -1
            lastP := pl
            lastB := pb
    else if dir == -1 and pl < lastP
        if array.size(zzP) > 0
            array.set(zzP, array.size(zzP) - 1, pl)
            array.set(zzB, array.size(zzB) - 1, pb)
            lastP := pl
            lastB := pb

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GET ZIGZAG POINT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

getPt(i) =>
    sz = array.size(zzP)
    if i < sz
        [array.get(zzP, sz-1-i), array.get(zzB, sz-1-i), array.get(zzT, sz-1-i)]
    else
        [0.0, 0, 0]

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WAVE 2 DETECTION (Entry for Wave 3)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

detectW2() =>
    [p0, b0, t0] = getPt(0)
    [p1, b1, t1] = getPt(1)
    [p2, b2, t2] = getPt(2)
    
    sig = false
    entry = 0.0
    tp = 0.0
    sl = 0.0
    
    if p0 > 0 and p1 > 0 and p2 > 0
        // Pattern: Low - High - Low (bullish)
        if t2 == -1 and t1 == 1 and t0 == -1
            w1size = p1 - p2
            w1pct = w1size / p2 * 100
            
            // Wave 1 must be significant
            if w1size > 0 and w1pct >= min_wave_pct
                ret = (p1 - p0) / w1size
                
                // Valid Wave 2 retracement
                if ret >= w2_min and ret <= w2_max
                    // Trend filter
                    trendOk = not use_trend or uptrend
                    
                    if trendOk
                        sig := true
                        entry := p0
                        tp := p0 + (w1size * tp_fib)
                        sl := p0 * (1 - sl_pct / 100)
    
    [sig, entry, tp, sl, b0]

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WAVE 4 DETECTION (Entry for Wave 5)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

detectW4() =>
    [p0, b0, t0] = getPt(0)
    [p1, b1, t1] = getPt(1)
    [p2, b2, t2] = getPt(2)
    [p3, b3, t3] = getPt(3)
    [p4, b4, t4] = getPt(4)
    
    sig = false
    entry = 0.0
    tp = 0.0
    sl = 0.0
    
    if p0 > 0 and p1 > 0 and p2 > 0 and p3 > 0 and p4 > 0
        // Pattern: Low - High - Low - High - Low
        if t4 == -1 and t3 == 1 and t2 == -1 and t1 == 1 and t0 == -1
            w1 = p3 - p4
            w3 = p1 - p2
            
            if w1 > 0 and w3 > 0
                // Wave 3 should be >= Wave 1 (Elliott rule)
                if w3 >= w1 * 0.9
                    ret = (p1 - p0) / w3
                    
                    // Valid Wave 4 retracement
                    if ret >= w4_min and ret <= w4_max
                        // Wave 4 must not enter Wave 1 territory
                        if p0 > p3
                            // Trend filter
                            trendOk = not use_trend or uptrend
                            
                            if trendOk
                                sig := true
                                entry := p0
                                tp := p0 + (w1 * 0.618)  // Wave 5 usually smaller
                                sl := p3 * 0.995
    
    [sig, entry, tp, sl, b0]

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIGNAL TRACKING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var int[] sigB = array.new_int(0)
var float[] sigE = array.new_float(0)
var float[] sigTP = array.new_float(0)
var float[] sigSL = array.new_float(0)
var int[] sigR = array.new_int(0)  // 0=open, 1=win, -1=loss
var int[] sigType = array.new_int(0)  // 3=W3, 5=W5

var int total = 0
var int wins = 0
var int losses = 0
var int lastSigBar = 0

[w2s, w2e, w2tp, w2sl, w2b] = detectW2()
[w4s, w4e, w4tp, w4sl, w4b] = detectW4()

// Process Wave 2 signal
var int lw2 = 0
if w2s and w2b != lw2 and (bar_index - lastSigBar) >= min_bars_between
    lw2 := w2b
    lastSigBar := bar_index
    array.push(sigB, w2b)
    array.push(sigE, w2e)
    array.push(sigTP, w2tp)
    array.push(sigSL, w2sl)
    array.push(sigR, 0)
    array.push(sigType, 3)
    total += 1
    
    if show_labels
        label.new(w2b, w2e, "ğŸŸ¢ W3", style=label.style_label_up, color=bull_color, textcolor=color.white, size=size.normal)
    if show_tp_sl
        line.new(w2b, w2tp, bar_index + 10, w2tp, color=color.new(color.green, 30), style=line.style_dashed, width=2)
        line.new(w2b, w2sl, bar_index + 10, w2sl, color=color.new(color.red, 30), style=line.style_dashed, width=2)

// Process Wave 4 signal
var int lw4 = 0
if w4s and w4b != lw4 and (bar_index - lastSigBar) >= min_bars_between
    lw4 := w4b
    lastSigBar := bar_index
    array.push(sigB, w4b)
    array.push(sigE, w4e)
    array.push(sigTP, w4tp)
    array.push(sigSL, w4sl)
    array.push(sigR, 0)
    array.push(sigType, 5)
    total += 1
    
    if show_labels
        label.new(w4b, w4e, "ğŸ”µ W5", style=label.style_label_up, color=color.teal, textcolor=color.white, size=size.normal)
    if show_tp_sl
        line.new(w4b, w4tp, bar_index + 10, w4tp, color=color.new(color.teal, 30), style=line.style_dashed, width=2)
        line.new(w4b, w4sl, bar_index + 10, w4sl, color=color.new(color.red, 30), style=line.style_dashed, width=2)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BACKTEST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if array.size(sigR) > 0
    for i = 0 to array.size(sigR) - 1
        if array.get(sigR, i) == 0
            t = array.get(sigTP, i)
            s = array.get(sigSL, i)
            if high >= t
                array.set(sigR, i, 1)
                wins += 1
            else if low <= s
                array.set(sigR, i, -1)
                losses += 1

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAW ZIGZAG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if show_zz and array.size(zzP) >= 2 and barstate.islast
    for i = 0 to math.min(array.size(zzP) - 2, 20)
        idx = array.size(zzP) - 1 - i
        if idx > 0
            b1 = array.get(zzB, idx-1)
            b2 = array.get(zzB, idx)
            if bar_index - b1 < 500 and bar_index - b2 < 500
                line.new(b1, array.get(zzP, idx-1), b2, array.get(zzP, idx), color=zz_color, width=zz_width)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATS TABLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if show_stats
    var table tbl = table.new(position.top_right, 2, 7, bgcolor=color.new(#1a1a2e, 10), border_width=2, border_color=color.gray)
    
    closed = wins + losses
    rate = closed > 0 ? (wins * 100.0 / closed) : 0.0
    openTrades = total - closed
    
    rateCol = rate >= 65 ? color.lime : rate >= 50 ? color.yellow : color.red
    rateBg = rate >= 65 ? color.new(color.green, 70) : rate >= 50 ? color.new(color.yellow, 70) : color.new(color.red, 70)
    
    // Header
    table.cell(tbl, 0, 0, "ğŸŒŠ ELLIOTT PRO", text_color=color.white, text_size=size.normal, bgcolor=color.new(color.blue, 50))
    table.cell(tbl, 1, 0, timeframe.period, text_color=color.yellow, text_size=size.normal, bgcolor=color.new(color.blue, 50))
    
    // Stats
    table.cell(tbl, 0, 1, "ğŸ“Š Signals", text_color=color.white, text_size=size.small)
    table.cell(tbl, 1, 1, str.tostring(total), text_color=color.white, text_size=size.small)
    
    table.cell(tbl, 0, 2, "âœ… Wins", text_color=color.lime, text_size=size.small)
    table.cell(tbl, 1, 2, str.tostring(wins), text_color=color.lime, text_size=size.small)
    
    table.cell(tbl, 0, 3, "âŒ Losses", text_color=color.red, text_size=size.small)
    table.cell(tbl, 1, 3, str.tostring(losses), text_color=color.red, text_size=size.small)
    
    table.cell(tbl, 0, 4, "â³ Open", text_color=color.orange, text_size=size.small)
    table.cell(tbl, 1, 4, str.tostring(openTrades), text_color=color.orange, text_size=size.small)
    
    table.cell(tbl, 0, 5, "ğŸ“ˆ Win Rate", text_color=color.white, text_size=size.normal, bgcolor=rateBg)
    table.cell(tbl, 1, 5, str.tostring(rate, "#.#") + "%", text_color=rateCol, text_size=size.large, bgcolor=rateBg)
    
    // Trend status
    trendTxt = uptrend ? "ğŸŸ¢ UPTREND" : "ğŸ”´ DOWNTREND"
    trendCol = uptrend ? color.new(color.green, 60) : color.new(color.red, 60)
    table.cell(tbl, 0, 6, "Trend", text_color=color.white, text_size=size.small, bgcolor=trendCol)
    table.cell(tbl, 1, 6, trendTxt, text_color=color.white, text_size=size.small, bgcolor=trendCol)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ALERTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

alertcondition(w2s, "Wave 3 Entry", "Elliott Wave: BUY for Wave 3!")
alertcondition(w4s, "Wave 5 Entry", "Elliott Wave: BUY for Wave 5!")
