//@version=6
indicator("Elliott + ICT v16 BALANCED 85%", overlay=true, max_labels_count=500, max_lines_count=500)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ¯ VERSION 16 - BALANCED (85% TARGET)
// Less strict filters but smart combinations
// Key: Quality over quantity, but still get signals
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â•â• INPUTS â•â•â•
grp_main = "ğŸ¯ MAIN SETTINGS"
min_strength = input.int(8, "Min Strength Score", minval=0, maxval=30, group=grp_main)
show_signals = input.bool(true, "Show Signals", group=grp_main)

grp_trigger = "âš¡ ENTRY TRIGGERS"
require_discount = input.bool(true, "Require Discount Zone", group=grp_trigger)
require_cisd = input.bool(false, "Require CISD", group=grp_trigger)
require_sweep = input.bool(false, "Require Sweep", group=grp_trigger)

grp_time = "â° KILL ZONES"
use_killzones = input.bool(false, "Only Kill Zones", group=grp_time)
london_start = input.int(2, "London Start", group=grp_time)
london_end = input.int(5, "London End", group=grp_time)
ny_start = input.int(7, "NY Start", group=grp_time)
ny_end = input.int(10, "NY End", group=grp_time)

grp_ict = "ğŸ¦ ICT SETTINGS"
ote_level = input.float(70.5, "OTE Level %", group=grp_ict)
ob_lookback = input.int(20, "OB Lookback", group=grp_ict)
fvg_min_size = input.float(0.1, "FVG Min %", group=grp_ict)

grp_ew = "ğŸŒŠ ELLIOTT WAVE"
zz_depth = input.int(10, "Zigzag Depth", group=grp_ew)
zz_dev = input.float(2.0, "Zigzag Dev %", group=grp_ew)
wave_retrace_min = input.float(0.5, "Retrace Min", group=grp_ew)
wave_retrace_max = input.float(0.786, "Retrace Max", group=grp_ew)

grp_tp = "ğŸ’° TARGETS"
tp_fib = input.float(1.618, "TP Fib", group=grp_tp)
sl_pct = input.float(1.5, "SL %", group=grp_tp)
signal_gap = input.int(10, "Min Bars Gap", group=grp_tp)

grp_vis = "ğŸ‘ VISUALS"
show_zigzag = input.bool(true, "Show Zigzag", group=grp_vis)
show_stats = input.bool(true, "Show Stats", group=grp_vis)
show_confluence = input.bool(true, "Show Panel", group=grp_vis)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“ˆ TREND FILTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ema50 = ta.ema(close, 50)
ema200 = ta.ema(close, 200)
trend_bullish = close > ema200

plot(ema50, "EMA 50", color=color.new(#00ccff, 50), linewidth=1)
plot(ema200, "EMA 200", color=trend_bullish ? #00ff88 : #ff4444, linewidth=2)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â° KILL ZONE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

utc_hour = hour(time, "UTC")
ny_hour = (utc_hour - 5 + 24) % 24
in_london_kz = ny_hour >= london_start and ny_hour < london_end
in_ny_kz = ny_hour >= ny_start and ny_hour < ny_end
kz_ok = not use_killzones or in_london_kz or in_ny_kz

bgcolor(in_london_kz ? color.new(color.blue, 95) : na)
bgcolor(in_ny_kz ? color.new(color.orange, 95) : na)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸŒŠ ZIGZAG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ph = ta.pivothigh(high, zz_depth, zz_depth)
pl = ta.pivotlow(low, zz_depth, zz_depth)

var float[] zzP = array.new_float(0)
var int[] zzB = array.new_int(0)
var int[] zzT = array.new_int(0)
var int dir = 0
var float lastP = 0.0

if not na(ph)
    pb = bar_index - zz_depth
    if dir == -1 and array.size(zzP) > 0 and math.abs(ph - lastP) / lastP * 100 >= zz_dev
        array.push(zzP, ph), array.push(zzB, pb), array.push(zzT, 1), dir := 1, lastP := ph
    else if array.size(zzP) == 0
        array.push(zzP, ph), array.push(zzB, pb), array.push(zzT, 1), dir := 1, lastP := ph
    else if dir == 1 and ph > lastP and array.size(zzP) > 0
        array.set(zzP, array.size(zzP)-1, ph), array.set(zzB, array.size(zzB)-1, pb), lastP := ph

if not na(pl)
    pb = bar_index - zz_depth
    if dir == 1 and array.size(zzP) > 0 and math.abs(pl - lastP) / lastP * 100 >= zz_dev
        array.push(zzP, pl), array.push(zzB, pb), array.push(zzT, -1), dir := -1, lastP := pl
    else if array.size(zzP) == 0
        array.push(zzP, pl), array.push(zzB, pb), array.push(zzT, -1), dir := -1, lastP := pl
    else if dir == -1 and pl < lastP and array.size(zzP) > 0
        array.set(zzP, array.size(zzP)-1, pl), array.set(zzB, array.size(zzB)-1, pb), lastP := pl

getPt(i) =>
    sz = array.size(zzP)
    if i < sz
        [array.get(zzP, sz-1-i), array.get(zzB, sz-1-i), array.get(zzT, sz-1-i)]
    else
        [0.0, 0, 0]

[p0, b0, t0] = getPt(0)
[p1, b1, t1] = getPt(1)
[p2, b2, t2] = getPt(2)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“Š PREMIUM / DISCOUNT / OTE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var float swing_high = na, var float swing_low = na
var float equilibrium = na, var float ote_price = na

if array.size(zzP) >= 2
    rh = math.max(p0, p1), rl = math.min(p0, p1)
    if rh > rl
        swing_high := rh, swing_low := rl
        equilibrium := (rh + rl) / 2
        ote_price := rh - ((rh - rl) * ote_level / 100)

in_discount = not na(equilibrium) and close < equilibrium
in_ote_zone = not na(ote_price) and close <= ote_price and close >= swing_low

plot(equilibrium, "EQ", color=color.gray, style=plot.style_linebr, linewidth=2)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“¦ ORDER BLOCK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var float bull_ob_top = na, var float bull_ob_bot = na

for i = 1 to ob_lookback
    if close[i] < open[i] and close[i-1] > open[i-1] and (close[i-1] - close[i]) / close[i] * 100 > 0.3
        bull_ob_top := high[i], bull_ob_bot := low[i]
        break

in_bull_ob = not na(bull_ob_bot) and close >= bull_ob_bot and close <= bull_ob_top

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“Š FVG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

bull_fvg_valid = low[0] > high[2] and (low[0] - high[2]) / close * 100 >= fvg_min_size

var float[] fvg_tops = array.new_float(0)
var float[] fvg_bots = array.new_float(0)

if bull_fvg_valid
    array.push(fvg_tops, low[0]), array.push(fvg_bots, high[2])
    if array.size(fvg_tops) > 10
        array.shift(fvg_tops), array.shift(fvg_bots)

fvg_being_filled = false
if array.size(fvg_tops) > 0
    for i = 0 to array.size(fvg_tops) - 1
        if close <= array.get(fvg_tops, i) and close >= array.get(fvg_bots, i)
            fvg_being_filled := true
            break

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ’§ LIQUIDITY SWEEP + CISD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

recent_low_val = ta.lowest(low, 10)[1]
swept_low = low < recent_low_val and close > recent_low_val

var float manip_high = na, var int manip_bar = na
var bool waiting_for_cisd = false
var bool had_sweep_recently = false
var int sweep_bar = 0

if swept_low
    had_sweep_recently := true, sweep_bar := bar_index

if bar_index - sweep_bar > 15
    had_sweep_recently := false

if swept_low and not waiting_for_cisd
    mh = high
    for i = 1 to 5
        if close[i] < open[i]
            mh := math.max(mh, high[i])
        else
            break
    manip_high := mh, manip_bar := bar_index, waiting_for_cisd := true

cisd_bullish = false
if waiting_for_cisd and not na(manip_high)
    if close > open and close > manip_high
        cisd_bullish := true, waiting_for_cisd := false
    if bar_index - manip_bar > 10
        waiting_for_cisd := false

sweep_ok = not require_sweep or had_sweep_recently
cisd_ok = not require_cisd or cisd_bullish

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸŒŠ ELLIOTT WAVE 2
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

wave2_setup = false
wave1_size = 0.0

if p0 > 0 and p1 > 0 and p2 > 0 and t2 == -1 and t1 == 1 and t0 == -1
    wave1_size := p1 - p2
    if wave1_size > 0
        retrace = (p1 - p0) / wave1_size
        wave2_setup := retrace >= wave_retrace_min and retrace <= wave_retrace_max

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ¯ SCORING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

score_kz = (in_london_kz or in_ny_kz) ? 2 : 0
score_trend = trend_bullish ? 2 : 0
score_discount = in_discount ? 2 : 0
score_ote = in_ote_zone ? 3 : 0
score_ob = in_bull_ob ? 2 : 0
score_fvg = fvg_being_filled ? 2 : 0
score_sweep = had_sweep_recently ? 2 : 0
score_wave2 = wave2_setup ? 3 : 0
score_cisd = cisd_bullish ? 3 : 0
score_bullcandle = close > open ? 1 : 0

strength_score = score_kz + score_trend + score_discount + score_ote + score_ob + score_fvg + score_sweep + score_wave2 + score_cisd + score_bullcandle

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸš€ SIGNAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

discount_ok = not require_discount or in_discount
base_conditions = discount_ok and cisd_ok and sweep_ok and close > open and kz_ok

bull_signal = base_conditions and strength_score >= min_strength

var int total = 0, var int wins = 0, var int losses = 0, var int lastSigBar = 0
var int[] sigB = array.new_int(0)
var float[] sigE = array.new_float(0)
var float[] sigTP = array.new_float(0)
var float[] sigSL = array.new_float(0)
var int[] sigR = array.new_int(0)

var bool show_signal = false
show_signal := false

if bull_signal and (bar_index - lastSigBar) > signal_gap and show_signals
    lastSigBar := bar_index
    entry = close
    tp = entry + (wave1_size > 0 ? wave1_size * tp_fib : entry * tp_fib / 100)
    sl = entry * (1 - sl_pct / 100)
    array.push(sigB, bar_index), array.push(sigE, entry)
    array.push(sigTP, tp), array.push(sigSL, sl), array.push(sigR, 0)
    total += 1
    show_signal := true

// Backtest
if array.size(sigR) > 0
    for i = 0 to array.size(sigR) - 1
        if array.get(sigR, i) == 0
            if high >= array.get(sigTP, i)
                array.set(sigR, i, 1), wins += 1
            else if low <= array.get(sigSL, i)
                array.set(sigR, i, -1), losses += 1

// Plot
plotshape(show_signal and strength_score >= 12, "STRONG", shape.labelup, location.belowbar, color.new(#00ff88, 0), text="ğŸ”¥", textcolor=color.white, size=size.normal)
plotshape(show_signal and strength_score >= 8 and strength_score < 12, "MEDIUM", shape.labelup, location.belowbar, color.new(#ffcc00, 0), text="âš¡", textcolor=color.white, size=size.small)

// Zigzag
if show_zigzag and array.size(zzP) >= 2 and barstate.islast
    for i = 0 to math.min(array.size(zzP) - 2, 15)
        idx = array.size(zzP) - 1 - i
        if idx > 0 and bar_index - array.get(zzB, idx-1) < 500
            line.new(array.get(zzB, idx-1), array.get(zzP, idx-1), array.get(zzB, idx), array.get(zzP, idx), color=array.get(zzT, idx) == 1 ? #00ff88 : #ff4444, width=3)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“Š STATS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if show_stats
    var table stats = table.new(position.top_right, 2, 7, bgcolor=color.new(#0d1117, 10), border_width=2, border_color=#00ccff)
    
    closed = wins + losses
    rate = closed > 0 ? (wins * 100.0 / closed) : 0.0
    rateCol = rate >= 85 ? #00ff88 : rate >= 70 ? #ffcc00 : rate >= 50 ? #ff9900 : #ff4444
    
    table.cell(stats, 0, 0, "âš¡ v16 BALANCED", text_color=#00ccff, bgcolor=color.new(#006699, 50), text_size=size.normal)
    table.cell(stats, 1, 0, timeframe.period, text_color=color.yellow, bgcolor=color.new(#006699, 50), text_size=size.normal)
    table.cell(stats, 0, 1, "Target", text_color=color.gray, text_size=size.tiny)
    table.cell(stats, 1, 1, "85%", text_color=#00ccff, text_size=size.tiny)
    table.cell(stats, 0, 2, "Signals", text_color=color.white, text_size=size.small)
    table.cell(stats, 1, 2, str.tostring(total), text_color=color.white, text_size=size.small)
    table.cell(stats, 0, 3, "âœ… Wins", text_color=#00ff88, text_size=size.small)
    table.cell(stats, 1, 3, str.tostring(wins), text_color=#00ff88, text_size=size.small)
    table.cell(stats, 0, 4, "âŒ Losses", text_color=#ff4444, text_size=size.small)
    table.cell(stats, 1, 4, str.tostring(losses), text_color=#ff4444, text_size=size.small)
    table.cell(stats, 0, 5, "â³ Open", text_color=color.orange, text_size=size.small)
    table.cell(stats, 1, 5, str.tostring(total - closed), text_color=color.orange, text_size=size.small)
    table.cell(stats, 0, 6, "ğŸ† WIN RATE", text_color=color.white, bgcolor=color.new(rateCol, 60), text_size=size.normal)
    table.cell(stats, 1, 6, str.tostring(rate, "#.#") + "%", text_color=rateCol, bgcolor=color.new(rateCol, 60), text_size=size.large)

// Panel
if show_confluence
    var table cpanel = table.new(position.bottom_right, 2, 11, bgcolor=color.new(#0d1117, 10), border_width=1)
    table.cell(cpanel, 0, 0, "âš¡ v16", text_color=#00ccff, bgcolor=color.new(#006699, 50), text_size=size.small)
    table.cell(cpanel, 1, 0, base_conditions and strength_score >= min_strength ? "âœ… GO" : "âŒ", text_color=base_conditions and strength_score >= min_strength ? #00ff88 : #ff6666, bgcolor=color.new(#006699, 50), text_size=size.small)
    table.cell(cpanel, 0, 1, "ğŸ“ˆ Trend", text_color=color.gray, text_size=size.tiny)
    table.cell(cpanel, 1, 1, trend_bullish ? "âœ…" : "â€”", text_color=trend_bullish ? #00ff88 : color.gray, text_size=size.tiny)
    table.cell(cpanel, 0, 2, "ğŸ’° Discount", text_color=color.gray, text_size=size.tiny)
    table.cell(cpanel, 1, 2, in_discount ? "âœ…" : "â€”", text_color=in_discount ? #00ff88 : color.gray, text_size=size.tiny)
    table.cell(cpanel, 0, 3, "ğŸ¯ OTE", text_color=color.gray, text_size=size.tiny)
    table.cell(cpanel, 1, 3, in_ote_zone ? "âœ…" : "â€”", text_color=in_ote_zone ? #00ff88 : color.gray, text_size=size.tiny)
    table.cell(cpanel, 0, 4, "ğŸ“¦ OB", text_color=color.gray, text_size=size.tiny)
    table.cell(cpanel, 1, 4, in_bull_ob ? "âœ…" : "â€”", text_color=in_bull_ob ? #00ff88 : color.gray, text_size=size.tiny)
    table.cell(cpanel, 0, 5, "ğŸ“Š FVG", text_color=color.gray, text_size=size.tiny)
    table.cell(cpanel, 1, 5, fvg_being_filled ? "âœ…" : "â€”", text_color=fvg_being_filled ? #00ff88 : color.gray, text_size=size.tiny)
    table.cell(cpanel, 0, 6, "ğŸ’§ Sweep", text_color=color.gray, text_size=size.tiny)
    table.cell(cpanel, 1, 6, had_sweep_recently ? "âœ…" : "â€”", text_color=had_sweep_recently ? #00ff88 : color.gray, text_size=size.tiny)
    table.cell(cpanel, 0, 7, "ğŸ”„ CISD", text_color=color.gray, text_size=size.tiny)
    table.cell(cpanel, 1, 7, cisd_bullish ? "âœ…" : "â€”", text_color=cisd_bullish ? #00ff88 : color.gray, text_size=size.tiny)
    table.cell(cpanel, 0, 8, "ğŸŒŠ Wave2", text_color=color.gray, text_size=size.tiny)
    table.cell(cpanel, 1, 8, wave2_setup ? "âœ…" : "â€”", text_color=wave2_setup ? #00ff88 : color.gray, text_size=size.tiny)
    table.cell(cpanel, 0, 9, "â° KZ", text_color=color.gray, text_size=size.tiny)
    table.cell(cpanel, 1, 9, (in_london_kz or in_ny_kz) ? "âœ…" : "â€”", text_color=(in_london_kz or in_ny_kz) ? #00ff88 : color.gray, text_size=size.tiny)
    table.cell(cpanel, 0, 10, "ğŸ’ª Score", text_color=color.white, text_size=size.tiny)
    table.cell(cpanel, 1, 10, str.tostring(strength_score) + "/22", text_color=strength_score >= min_strength ? #00ff88 : #ff6666, text_size=size.tiny)

alertcondition(bull_signal, "v16 BUY", "âš¡ v16 BALANCED: BUY Signal!")
