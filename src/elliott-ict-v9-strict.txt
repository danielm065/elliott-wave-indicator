//@version=6
indicator("Elliott + ICT v9 STRICT", overlay=true, max_labels_count=500, max_lines_count=500)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ¯ VERSION 9 - STRICT MODE
// Focus: HIGH WIN RATE (85%+)
// Strategy: Only take highest quality setups
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â•â• INPUTS â•â•â•
grp_main = "ğŸ¯ MAIN SETTINGS"
min_strength = input.int(8, "Min Strength Score", minval=0, maxval=20, group=grp_main, tooltip="Higher = fewer but better signals")
show_signals = input.bool(true, "Show Signals", group=grp_main)

grp_trigger = "âš¡ TRIGGER CONDITIONS (Need at least 2)"
req_discount = input.bool(true, "Require Discount Zone", group=grp_trigger)
req_fvg = input.bool(true, "Require FVG Fill", group=grp_trigger)
req_cisd = input.bool(true, "Require CISD", group=grp_trigger)
req_smt = input.bool(true, "Require SMT", group=grp_trigger)
min_triggers = input.int(2, "Minimum Triggers Required", minval=1, maxval=4, group=grp_trigger)

grp_smt = "ğŸ”€ SMT SETTINGS"
smt_symbol = input.symbol("CME_MINI:ES1!", "Compare Symbol", group=grp_smt)
smt_lookback = input.int(10, "SMT Lookback", minval=5, maxval=50, group=grp_smt)

grp_time = "â° KILL ZONES (NY Time)"
use_killzones = input.bool(true, "Only Trade Kill Zones", group=grp_time)
london_start = input.int(2, "London Start", group=grp_time)
london_end = input.int(5, "London End", group=grp_time)
ny_start = input.int(7, "NY Start", group=grp_time)
ny_end = input.int(10, "NY End", group=grp_time)

grp_ict = "ğŸ¦ ICT SETTINGS"
ote_level = input.float(70.5, "OTE Sweet Spot %", minval=60, maxval=80, group=grp_ict)
ob_lookback = input.int(20, "Order Block Lookback", group=grp_ict)
fvg_min_size = input.float(0.1, "FVG Min Size %", group=grp_ict)
displacement_mult = input.float(2.0, "Displacement Multiplier", group=grp_ict)

grp_ew = "ğŸŒŠ ELLIOTT WAVE"
zz_depth = input.int(10, "Zigzag Depth", group=grp_ew)
zz_dev = input.float(2.0, "Zigzag Deviation %", group=grp_ew)
wave_retrace_min = input.float(0.5, "Wave Retrace Min", group=grp_ew)
wave_retrace_max = input.float(0.786, "Wave Retrace Max", group=grp_ew)

grp_tp = "ğŸ’° TARGETS"
tp_fib = input.float(1.618, "Take Profit Fib", group=grp_tp)
sl_pct = input.float(1.5, "Stop Loss %", group=grp_tp, tooltip="Tighter SL for better RR")

grp_filter = "ğŸ”’ STRICT FILTERS"
req_bullish_candle = input.bool(true, "Require Bullish Confirmation Candle", group=grp_filter)
req_volume = input.bool(true, "Require Above Avg Volume", group=grp_filter)
volume_mult = input.float(1.2, "Volume Multiplier", group=grp_filter)
avoid_extended = input.bool(true, "Avoid Extended Moves", group=grp_filter)
extended_atr_mult = input.float(3.0, "Extended ATR Multiplier", group=grp_filter)

grp_vis = "ğŸ‘ VISUALS"
show_zigzag = input.bool(true, "Show Zigzag", group=grp_vis)
show_ob = input.bool(true, "Show Order Blocks", group=grp_vis)
show_fvg = input.bool(true, "Show FVG", group=grp_vis)
show_zones = input.bool(true, "Show Premium/Discount", group=grp_vis)
show_stats = input.bool(true, "Show Stats Table", group=grp_vis)
show_confluence = input.bool(true, "Show Confluence Panel", group=grp_vis)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â° KILL ZONE DETECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

utc_hour = hour(time, "UTC")
ny_hour = (utc_hour - 5 + 24) % 24

in_london_kz = ny_hour >= london_start and ny_hour < london_end
in_ny_kz = ny_hour >= ny_start and ny_hour < ny_end
in_any_kz = in_london_kz or in_ny_kz
kz_ok = not use_killzones or in_any_kz

bgcolor(in_london_kz ? color.new(color.blue, 95) : na, title="London KZ")
bgcolor(in_ny_kz ? color.new(color.orange, 95) : na, title="NY KZ")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“Š VOLUME FILTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

vol_sma = ta.sma(volume, 20)
volume_ok = not req_volume or volume > vol_sma * volume_mult

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“ EXTENDED MOVE FILTER (avoid chasing)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

atr = ta.atr(14)
recent_move = math.abs(close - close[5])
is_extended = recent_move > atr * extended_atr_mult
not_extended = not avoid_extended or not is_extended

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”€ SMT - SMART MONEY TECHNIQUE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[smt_open, smt_high, smt_low, smt_close] = request.security(smt_symbol, timeframe.period, [open, high, low, close])

main_ph = ta.pivothigh(high, smt_lookback, smt_lookback)
main_pl = ta.pivotlow(low, smt_lookback, smt_lookback)
comp_ph = ta.pivothigh(smt_high, smt_lookback, smt_lookback)
comp_pl = ta.pivotlow(smt_low, smt_lookback, smt_lookback)

var float main_last_high = na
var float main_prev_high = na
var float main_last_low = na
var float main_prev_low = na
var float comp_last_high = na
var float comp_prev_high = na
var float comp_last_low = na
var float comp_prev_low = na

if not na(main_ph)
    main_prev_high := main_last_high
    main_last_high := main_ph

if not na(main_pl)
    main_prev_low := main_last_low
    main_last_low := main_pl

if not na(comp_ph)
    comp_prev_high := comp_last_high
    comp_last_high := comp_ph

if not na(comp_pl)
    comp_prev_low := comp_last_low
    comp_last_low := comp_pl

smt_bullish = false
if not na(main_last_low) and not na(main_prev_low) and not na(comp_last_low) and not na(comp_prev_low)
    main_made_ll = main_last_low < main_prev_low
    comp_made_hl = comp_last_low > comp_prev_low
    smt_bullish := main_made_ll and comp_made_hl

smt_bearish = false
if not na(main_last_high) and not na(main_prev_high) and not na(comp_last_high) and not na(comp_prev_high)
    main_made_hh = main_last_high > main_prev_high
    comp_made_lh = comp_last_high < comp_prev_high
    smt_bearish := main_made_hh and comp_made_lh

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸŒŠ ZIGZAG (Elliott Wave Structure)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ph = ta.pivothigh(high, zz_depth, zz_depth)
pl = ta.pivotlow(low, zz_depth, zz_depth)

var float[] zzP = array.new_float(0)
var int[] zzB = array.new_int(0)
var int[] zzT = array.new_int(0)
var int dir = 0
var float lastP = 0.0

if not na(ph)
    pb = bar_index - zz_depth
    if dir <= 0 and array.size(zzP) > 0 and dir == -1
        if math.abs(ph - lastP) / lastP * 100 >= zz_dev
            array.push(zzP, ph)
            array.push(zzB, pb)
            array.push(zzT, 1)
            dir := 1
            lastP := ph
    else if dir <= 0 and array.size(zzP) == 0
        array.push(zzP, ph)
        array.push(zzB, pb)
        array.push(zzT, 1)
        dir := 1
        lastP := ph
    else if dir == 1 and ph > lastP and array.size(zzP) > 0
        array.set(zzP, array.size(zzP) - 1, ph)
        array.set(zzB, array.size(zzB) - 1, pb)
        lastP := ph

if not na(pl)
    pb = bar_index - zz_depth
    if dir >= 0 and array.size(zzP) > 0 and dir == 1
        if math.abs(pl - lastP) / lastP * 100 >= zz_dev
            array.push(zzP, pl)
            array.push(zzB, pb)
            array.push(zzT, -1)
            dir := -1
            lastP := pl
    else if dir >= 0 and array.size(zzP) == 0
        array.push(zzP, pl)
        array.push(zzB, pb)
        array.push(zzT, -1)
        dir := -1
        lastP := pl
    else if dir == -1 and pl < lastP and array.size(zzP) > 0
        array.set(zzP, array.size(zzP) - 1, pl)
        array.set(zzB, array.size(zzB) - 1, pb)
        lastP := pl

getPt(i) =>
    sz = array.size(zzP)
    if i < sz
        [array.get(zzP, sz-1-i), array.get(zzB, sz-1-i), array.get(zzT, sz-1-i)]
    else
        [0.0, 0, 0]

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“Š PREMIUM / DISCOUNT / OTE ZONES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[p0, b0, t0] = getPt(0)
[p1, b1, t1] = getPt(1)
[p2, b2, t2] = getPt(2)

var float swing_high = na
var float swing_low = na
var float equilibrium = na
var float ote_price = na

if array.size(zzP) >= 2
    recent_high = math.max(p0, p1)
    recent_low = math.min(p0, p1)
    if recent_high > recent_low
        swing_high := recent_high
        swing_low := recent_low
        equilibrium := (swing_high + swing_low) / 2
        range_size = swing_high - swing_low
        ote_price := swing_high - (range_size * ote_level / 100)

in_discount = not na(equilibrium) and close < equilibrium
in_premium = not na(equilibrium) and close > equilibrium
in_ote_zone = not na(ote_price) and close <= ote_price and close >= swing_low
in_deep_discount = not na(swing_low) and close <= swing_low + (equilibrium - swing_low) * 0.3

plot(show_zones and not na(equilibrium) ? equilibrium : na, "Equilibrium", color=color.gray, style=plot.style_linebr, linewidth=2)
plot(show_zones and not na(ote_price) ? ote_price : na, "OTE Level", color=color.new(#ff6600, 50), style=plot.style_linebr, linewidth=1)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“¦ ORDER BLOCK DETECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var float bull_ob_top = na
var float bull_ob_bot = na
var int bull_ob_bar = na

bull_ob_found = false
for i = 1 to ob_lookback
    if close[i] < open[i] and close[i-1] > open[i-1]
        move_size = (close[i-1] - close[i]) / close[i] * 100
        if move_size > 0.5
            bull_ob_top := high[i]
            bull_ob_bot := low[i]
            bull_ob_bar := bar_index - i
            bull_ob_found := true
            break

in_bull_ob = not na(bull_ob_bot) and close >= bull_ob_bot and close <= bull_ob_top

if show_ob and bull_ob_found and barstate.islast
    box.new(bull_ob_bar, bull_ob_top, bar_index + 5, bull_ob_bot, 
            bgcolor=color.new(color.green, 85), border_color=color.green, border_width=1)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“Š FAIR VALUE GAP (FVG) DETECTION + FILL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

bull_fvg = low[0] > high[2]
bull_fvg_size = bull_fvg ? (low[0] - high[2]) / close * 100 : 0
bull_fvg_valid = bull_fvg and bull_fvg_size >= fvg_min_size

var float[] fvg_tops = array.new_float(0)
var float[] fvg_bots = array.new_float(0)
var int[] fvg_bars = array.new_int(0)

if bull_fvg_valid
    array.push(fvg_tops, low[0])
    array.push(fvg_bots, high[2])
    array.push(fvg_bars, bar_index - 1)
    if array.size(fvg_tops) > 10
        array.shift(fvg_tops)
        array.shift(fvg_bots)
        array.shift(fvg_bars)

fvg_being_filled = false
var float filled_fvg_top = na
var float filled_fvg_bot = na

if array.size(fvg_tops) > 0
    for i = 0 to array.size(fvg_tops) - 1
        ftop = array.get(fvg_tops, i)
        fbot = array.get(fvg_bots, i)
        if close <= ftop and close >= fbot
            fvg_being_filled := true
            filled_fvg_top := ftop
            filled_fvg_bot := fbot
            break

if show_fvg and bull_fvg_valid
    box.new(bar_index - 2, low[0], bar_index, high[2], 
            bgcolor=color.new(color.blue, 85), border_color=color.blue, border_width=1)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ’¥ DISPLACEMENT DETECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

candle_size = math.abs(close - open)
displacement = candle_size > atr * displacement_mult

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ’§ LIQUIDITY SWEEP + CISD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

recent_low_val = ta.lowest(low, 10)[1]
recent_high_val = ta.highest(high, 10)[1]
swept_low = low < recent_low_val and close > recent_low_val
swept_high = high > recent_high_val and close < recent_high_val

var float manip_high = na
var float manip_low = na
var int manip_bar = na
var bool waiting_for_cisd_bull = false
var bool waiting_for_cisd_bear = false

if swept_low and not waiting_for_cisd_bull
    manip_h = high
    manip_l = low
    for i = 1 to 5
        if close[i] < open[i]
            manip_h := math.max(manip_h, high[i])
            manip_l := math.min(manip_l, low[i])
        else
            break
    manip_high := manip_h
    manip_low := manip_l
    manip_bar := bar_index
    waiting_for_cisd_bull := true
    waiting_for_cisd_bear := false

if swept_high and not waiting_for_cisd_bear
    manip_h = high
    manip_l = low
    for i = 1 to 5
        if close[i] > open[i]
            manip_h := math.max(manip_h, high[i])
            manip_l := math.min(manip_l, low[i])
        else
            break
    manip_high := manip_h
    manip_low := manip_l
    manip_bar := bar_index
    waiting_for_cisd_bear := true
    waiting_for_cisd_bull := false

cisd_bullish = false
cisd_bearish = false

if waiting_for_cisd_bull and not na(manip_high)
    if close > open and close > manip_high
        cisd_bullish := true
        waiting_for_cisd_bull := false
    if bar_index - manip_bar > 10
        waiting_for_cisd_bull := false

if waiting_for_cisd_bear and not na(manip_low)
    if close < open and close < manip_low
        cisd_bearish := true
        waiting_for_cisd_bear := false
    if bar_index - manip_bar > 10
        waiting_for_cisd_bear := false

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸŒŠ ELLIOTT WAVE 2 DETECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

wave2_setup = false
wave1_size = 0.0

if p0 > 0 and p1 > 0 and p2 > 0
    if t2 == -1 and t1 == 1 and t0 == -1
        wave1_size := p1 - p2
        if wave1_size > 0
            retrace = (p1 - p0) / wave1_size
            wave2_setup := retrace >= wave_retrace_min and retrace <= wave_retrace_max

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ¯ TRIGGER COUNTING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

trigger_discount = req_discount and in_discount
trigger_fvg = req_fvg and fvg_being_filled
trigger_cisd = req_cisd and cisd_bullish
trigger_smt = req_smt and smt_bullish

trigger_count = (trigger_discount ? 1 : 0) + (trigger_fvg ? 1 : 0) + (trigger_cisd ? 1 : 0) + (trigger_smt ? 1 : 0)
triggers_met = trigger_count >= min_triggers

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ¯ CONFLUENCE SCORING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

score_kz = kz_ok ? 2 : 0
score_discount = in_discount ? 2 : 0
score_deep_discount = in_deep_discount ? 2 : 0
score_ote = in_ote_zone ? 3 : 0
score_ob = in_bull_ob ? 2 : 0
score_fvg = fvg_being_filled ? 3 : 0
score_displacement = displacement[1] or displacement[2] ? 2 : 0
score_sweep = swept_low ? 2 : 0
score_wave2 = wave2_setup ? 3 : 0
score_smt = smt_bullish ? 4 : 0
score_cisd = cisd_bullish ? 4 : 0
score_volume = volume_ok ? 1 : 0

strength_score = score_kz + score_discount + score_deep_discount + score_ote + score_ob + score_fvg + score_displacement + score_sweep + score_wave2 + score_smt + score_cisd + score_volume
// Max = 30

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸš€ STRICT SIGNAL GENERATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

bullish_candle = close > open
candle_confirm = not req_bullish_candle or bullish_candle

// ALL conditions must be met for STRICT mode
bull_signal = triggers_met and in_discount and candle_confirm and volume_ok and not_extended and kz_ok and strength_score >= min_strength

var int[] sigB = array.new_int(0)
var float[] sigE = array.new_float(0)
var float[] sigTP = array.new_float(0)
var float[] sigSL = array.new_float(0)
var int[] sigR = array.new_int(0)

var int total = 0
var int wins = 0
var int losses = 0
var int lastSigBar = 0

var bool show_buy_signal = false
show_buy_signal := false

if bull_signal and (bar_index - lastSigBar) > 10 and show_signals
    lastSigBar := bar_index
    
    entry = close
    tp = entry + (wave1_size > 0 ? wave1_size * tp_fib : entry * tp_fib / 100)
    sl = entry * (1 - sl_pct / 100)
    
    array.push(sigB, bar_index)
    array.push(sigE, entry)
    array.push(sigTP, tp)
    array.push(sigSL, sl)
    array.push(sigR, 0)
    total += 1
    show_buy_signal := true

// Plot signal
plotshape(show_buy_signal, "BUY STRICT", style=shape.labelup, location=location.belowbar, 
          color=color.new(#00ff88, 0), text="ğŸ¯BUY", textcolor=color.white, size=size.normal)

// Backtest
if array.size(sigR) > 0
    for i = 0 to array.size(sigR) - 1
        if array.get(sigR, i) == 0
            if high >= array.get(sigTP, i)
                array.set(sigR, i, 1)
                wins += 1
            else if low <= array.get(sigSL, i)
                array.set(sigR, i, -1)
                losses += 1

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”€ DRAW ZIGZAG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if show_zigzag and array.size(zzP) >= 2 and barstate.islast
    for i = 0 to math.min(array.size(zzP) - 2, 15)
        idx = array.size(zzP) - 1 - i
        if idx > 0 and bar_index - array.get(zzB, idx-1) < 500
            col = array.get(zzT, idx) == 1 ? #00ff88 : #ff4444
            line.new(array.get(zzB, idx-1), array.get(zzP, idx-1), array.get(zzB, idx), array.get(zzP, idx), color=col, width=3)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“Š CONFLUENCE PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if show_confluence
    var table cpanel = table.new(position.bottom_right, 2, 14, bgcolor=color.new(#0d1117, 10), border_width=1)
    
    table.cell(cpanel, 0, 0, "ğŸ¯ STRICT", text_color=#00ccff, bgcolor=color.new(#0066cc, 50), text_size=size.small)
    table.cell(cpanel, 1, 0, triggers_met ? "âœ… " + str.tostring(trigger_count) + " TRIG" : "âŒ " + str.tostring(trigger_count) + "/" + str.tostring(min_triggers), text_color=triggers_met ? #00ff88 : #ff6666, bgcolor=color.new(#0066cc, 50), text_size=size.small)
    
    table.cell(cpanel, 0, 1, "ğŸ’° Discount", text_color=color.gray, text_size=size.tiny)
    table.cell(cpanel, 1, 1, trigger_discount ? "âœ…" : "â€”", text_color=trigger_discount ? #00ff88 : color.gray, text_size=size.tiny)
    
    table.cell(cpanel, 0, 2, "ğŸ“Š FVG Fill", text_color=color.gray, text_size=size.tiny)
    table.cell(cpanel, 1, 2, trigger_fvg ? "âœ…" : "â€”", text_color=trigger_fvg ? #00ff88 : color.gray, text_size=size.tiny)
    
    table.cell(cpanel, 0, 3, "ğŸ”„ CISD", text_color=color.gray, text_size=size.tiny)
    table.cell(cpanel, 1, 3, trigger_cisd ? "âœ…" : "â€”", text_color=trigger_cisd ? #00ff88 : color.gray, text_size=size.tiny)
    
    table.cell(cpanel, 0, 4, "ğŸ”€ SMT", text_color=color.gray, text_size=size.tiny)
    table.cell(cpanel, 1, 4, trigger_smt ? "âœ…" : "â€”", text_color=trigger_smt ? #00ff88 : color.gray, text_size=size.tiny)
    
    table.cell(cpanel, 0, 5, "ğŸ’ª Score", text_color=color.white, text_size=size.tiny)
    table.cell(cpanel, 1, 5, str.tostring(strength_score) + "/30", text_color=strength_score >= min_strength ? #00ff88 : #ff6666, text_size=size.tiny)
    
    table.cell(cpanel, 0, 6, "â”€â”€â”€â”€â”€â”€â”€", text_color=color.gray, text_size=size.tiny)
    table.cell(cpanel, 1, 6, "â”€â”€â”€â”€â”€â”€â”€", text_color=color.gray, text_size=size.tiny)
    
    table.cell(cpanel, 0, 7, "â° Kill Zone", text_color=color.gray, text_size=size.tiny)
    table.cell(cpanel, 1, 7, kz_ok ? "âœ…" : "âŒ", text_color=kz_ok ? #00ff88 : #ff6666, text_size=size.tiny)
    
    table.cell(cpanel, 0, 8, "ğŸ“ˆ Volume", text_color=color.gray, text_size=size.tiny)
    table.cell(cpanel, 1, 8, volume_ok ? "âœ…" : "âŒ", text_color=volume_ok ? #00ff88 : #ff6666, text_size=size.tiny)
    
    table.cell(cpanel, 0, 9, "ğŸš« Extended", text_color=color.gray, text_size=size.tiny)
    table.cell(cpanel, 1, 9, not_extended ? "âœ…" : "âŒ", text_color=not_extended ? #00ff88 : #ff6666, text_size=size.tiny)
    
    table.cell(cpanel, 0, 10, "ğŸ¯ OTE Zone", text_color=color.gray, text_size=size.tiny)
    table.cell(cpanel, 1, 10, in_ote_zone ? "âœ…" : "â€”", text_color=in_ote_zone ? #00ff88 : color.gray, text_size=size.tiny)
    
    table.cell(cpanel, 0, 11, "ğŸ“¦ Order Block", text_color=color.gray, text_size=size.tiny)
    table.cell(cpanel, 1, 11, in_bull_ob ? "âœ…" : "â€”", text_color=in_bull_ob ? #00ff88 : color.gray, text_size=size.tiny)
    
    table.cell(cpanel, 0, 12, "ğŸŒŠ Wave 2", text_color=color.gray, text_size=size.tiny)
    table.cell(cpanel, 1, 12, wave2_setup ? "âœ…" : "â€”", text_color=wave2_setup ? #00ff88 : color.gray, text_size=size.tiny)
    
    table.cell(cpanel, 0, 13, "ğŸ’¥ Displace", text_color=color.gray, text_size=size.tiny)
    table.cell(cpanel, 1, 13, displacement[1] or displacement[2] ? "âœ…" : "â€”", text_color=displacement[1] or displacement[2] ? #00ff88 : color.gray, text_size=size.tiny)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“ˆ STATS TABLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if show_stats
    var table stats = table.new(position.top_right, 2, 6, bgcolor=color.new(#0d1117, 10), border_width=2, border_color=#00ccff)
    
    closed = wins + losses
    rate = closed > 0 ? (wins * 100.0 / closed) : 0.0
    rateCol = rate >= 85 ? #00ff88 : rate >= 70 ? #ffcc00 : #ff4444
    
    table.cell(stats, 0, 0, "ğŸ¯ STRICT v9", text_color=#00ccff, bgcolor=color.new(#0066cc, 50), text_size=size.normal)
    table.cell(stats, 1, 0, timeframe.period, text_color=color.yellow, bgcolor=color.new(#0066cc, 50), text_size=size.normal)
    
    table.cell(stats, 0, 1, "Signals", text_color=color.white, text_size=size.small)
    table.cell(stats, 1, 1, str.tostring(total), text_color=color.white, text_size=size.small)
    
    table.cell(stats, 0, 2, "âœ… Wins", text_color=#00ff88, text_size=size.small)
    table.cell(stats, 1, 2, str.tostring(wins), text_color=#00ff88, text_size=size.small)
    
    table.cell(stats, 0, 3, "âŒ Losses", text_color=#ff4444, text_size=size.small)
    table.cell(stats, 1, 3, str.tostring(losses), text_color=#ff4444, text_size=size.small)
    
    table.cell(stats, 0, 4, "â³ Open", text_color=color.orange, text_size=size.small)
    table.cell(stats, 1, 4, str.tostring(total - closed), text_color=color.orange, text_size=size.small)
    
    table.cell(stats, 0, 5, "ğŸ† WIN RATE", text_color=color.white, bgcolor=color.new(rateCol, 60), text_size=size.normal)
    table.cell(stats, 1, 5, str.tostring(rate, "#.#") + "%", text_color=rateCol, bgcolor=color.new(rateCol, 60), text_size=size.large)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”” ALERTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

alertcondition(bull_signal, "STRICT BUY", "ğŸ¯ STRICT: High Quality BUY Signal!")
