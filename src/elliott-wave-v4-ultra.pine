//@version=6
indicator("Elliott Wave ULTRA", overlay=true, max_labels_count=200, max_lines_count=200)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ULTRA MODE - HIGH WIN RATE (fewer signals, better quality)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

grp_zz = "ğŸ”€ ZIGZAG"
zz_depth = input.int(14, "Depth", minval=8, maxval=30, group=grp_zz)
zz_dev = input.float(2.5, "Deviation %", minval=1.0, maxval=8.0, group=grp_zz)

grp_ew = "ğŸŒŠ ELLIOTT (STRICT)"
w2_min = input.float(0.5, "Wave 2 Min Retrace", group=grp_ew)
w2_max = input.float(0.618, "Wave 2 Max Retrace", group=grp_ew, tooltip="Golden ratio zone")
min_wave_pct = input.float(3.0, "Min Wave 1 Size %", group=grp_ew)
w3_multiplier = input.float(1.5, "Wave 3 Min vs Wave 1", group=grp_ew, tooltip="Wave 3 must be at least this * Wave 1")

grp_conf = "âœ… CONFIRMATIONS"
use_trend = input.bool(true, "Trend Filter (EMA)", group=grp_conf)
ema_len = input.int(100, "EMA Length", minval=20, maxval=200, group=grp_conf)
use_rsi = input.bool(true, "RSI Filter", group=grp_conf)
rsi_len = input.int(14, "RSI Length", group=grp_conf)
rsi_ob = input.int(70, "RSI Overbought", group=grp_conf, tooltip="Don't buy above this")
rsi_os = input.int(40, "RSI Max for Buy", group=grp_conf, tooltip="Buy when RSI is below this")
use_momentum = input.bool(true, "Momentum Filter", group=grp_conf)
mom_len = input.int(10, "Momentum Length", group=grp_conf)

grp_rr = "ğŸ’° RISK/REWARD"
min_rr = input.float(2.0, "Min Risk:Reward", group=grp_rr, tooltip="Only take trades with R:R >= this")
tp_fib = input.float(1.618, "Take Profit Fib", group=grp_rr)
sl_pct = input.float(2.0, "Stop Loss %", group=grp_rr)

grp_time = "â° TIMING"
min_bars = input.int(10, "Min Bars Between Signals", group=grp_time)

grp_vis = "ğŸ‘ VISUALS"
show_zz = input.bool(true, "Show Zigzag", group=grp_vis)
show_ema = input.bool(true, "Show EMA", group=grp_vis)
show_labels = input.bool(true, "Show Signals", group=grp_vis)
show_stats = input.bool(true, "Show Stats", group=grp_vis)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INDICATORS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ema_val = ta.ema(close, ema_len)
rsi_val = ta.rsi(close, rsi_len)
mom_val = ta.mom(close, mom_len)

uptrend = close > ema_val
rsi_ok = rsi_val < rsi_ob and rsi_val < rsi_os
mom_ok = mom_val > 0

plot(show_ema ? ema_val : na, "EMA", color=uptrend ? color.green : color.red, linewidth=2)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ZIGZAG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ph = ta.pivothigh(high, zz_depth, zz_depth)
pl = ta.pivotlow(low, zz_depth, zz_depth)

var float[] zzP = array.new_float(0)
var int[] zzB = array.new_int(0)
var int[] zzT = array.new_int(0)

var int dir = 0
var float lastP = 0.0

if not na(ph)
    pb = bar_index - zz_depth
    if dir <= 0
        if array.size(zzP) > 0 and dir == -1
            if math.abs(ph - lastP) / lastP * 100 >= zz_dev
                array.push(zzP, ph)
                array.push(zzB, pb)
                array.push(zzT, 1)
                dir := 1
                lastP := ph
        else if array.size(zzP) == 0
            array.push(zzP, ph)
            array.push(zzB, pb)
            array.push(zzT, 1)
            dir := 1
            lastP := ph
    else if dir == 1 and ph > lastP
        if array.size(zzP) > 0
            array.set(zzP, array.size(zzP) - 1, ph)
            array.set(zzB, array.size(zzB) - 1, pb)
            lastP := ph

if not na(pl)
    pb = bar_index - zz_depth
    if dir >= 0
        if array.size(zzP) > 0 and dir == 1
            if math.abs(pl - lastP) / lastP * 100 >= zz_dev
                array.push(zzP, pl)
                array.push(zzB, pb)
                array.push(zzT, -1)
                dir := -1
                lastP := pl
        else if array.size(zzP) == 0
            array.push(zzP, pl)
            array.push(zzB, pb)
            array.push(zzT, -1)
            dir := -1
            lastP := pl
    else if dir == -1 and pl < lastP
        if array.size(zzP) > 0
            array.set(zzP, array.size(zzP) - 1, pl)
            array.set(zzB, array.size(zzB) - 1, pb)
            lastP := pl

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GET POINT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

getPt(i) =>
    sz = array.size(zzP)
    i < sz ? [array.get(zzP, sz-1-i), array.get(zzB, sz-1-i), array.get(zzT, sz-1-i)] : [0.0, 0, 0]

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ULTRA WAVE 2 DETECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

detectW2Ultra() =>
    [p0, b0, t0] = getPt(0)
    [p1, b1, t1] = getPt(1)
    [p2, b2, t2] = getPt(2)
    
    sig = false
    entry = 0.0
    tp = 0.0
    sl = 0.0
    rr = 0.0
    
    if p0 > 0 and p1 > 0 and p2 > 0
        if t2 == -1 and t1 == 1 and t0 == -1  // Low-High-Low
            w1 = p1 - p2
            w1pct = w1 / p2 * 100
            
            if w1 > 0 and w1pct >= min_wave_pct
                ret = (p1 - p0) / w1
                
                // STRICT: Golden ratio zone only (50-61.8%)
                if ret >= w2_min and ret <= w2_max
                    entry := p0
                    tp := p0 + (w1 * tp_fib)
                    sl := p0 * (1 - sl_pct / 100)
                    
                    reward = tp - entry
                    risk = entry - sl
                    rr := risk > 0 ? reward / risk : 0
                    
                    // ALL CONDITIONS MUST PASS
                    trendPass = not use_trend or uptrend
                    rsiPass = not use_rsi or rsi_ok
                    momPass = not use_momentum or mom_ok
                    rrPass = rr >= min_rr
                    
                    if trendPass and rsiPass and momPass and rrPass
                        sig := true
    
    [sig, entry, tp, sl, rr, b0]

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ULTRA WAVE 4 DETECTION  
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

detectW4Ultra() =>
    [p0, b0, t0] = getPt(0)
    [p1, b1, t1] = getPt(1)
    [p2, b2, t2] = getPt(2)
    [p3, b3, t3] = getPt(3)
    [p4, b4, t4] = getPt(4)
    
    sig = false
    entry = 0.0
    tp = 0.0
    sl = 0.0
    rr = 0.0
    
    if p0 > 0 and p1 > 0 and p2 > 0 and p3 > 0 and p4 > 0
        if t4 == -1 and t3 == 1 and t2 == -1 and t1 == 1 and t0 == -1
            w1 = p3 - p4
            w3 = p1 - p2
            
            if w1 > 0 and w3 > 0
                // STRICT: Wave 3 must be significantly larger than Wave 1
                if w3 >= w1 * w3_multiplier
                    ret = (p1 - p0) / w3
                    
                    // Wave 4: 23.6-38.2% retracement
                    if ret >= 0.236 and ret <= 0.382
                        // Wave 4 must not enter Wave 1 territory
                        if p0 > p3
                            entry := p0
                            tp := p0 + (w1 * 0.618)  // Conservative W5 target
                            sl := p3 * 0.998
                            
                            reward = tp - entry
                            risk = entry - sl
                            rr := risk > 0 ? reward / risk : 0
                            
                            trendPass = not use_trend or uptrend
                            rsiPass = not use_rsi or rsi_ok
                            momPass = not use_momentum or mom_ok
                            rrPass = rr >= min_rr
                            
                            if trendPass and rsiPass and momPass and rrPass
                                sig := true
    
    [sig, entry, tp, sl, rr, b0]

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRACKING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var int[] sigB = array.new_int(0)
var float[] sigE = array.new_float(0)
var float[] sigTP = array.new_float(0)
var float[] sigSL = array.new_float(0)
var int[] sigR = array.new_int(0)

var int total = 0
var int wins = 0
var int losses = 0
var int lastSigBar = 0

[w2s, w2e, w2tp, w2sl, w2rr, w2b] = detectW2Ultra()
[w4s, w4e, w4tp, w4sl, w4rr, w4b] = detectW4Ultra()

// Wave 2 Signal
var int lw2 = 0
if w2s and w2b != lw2 and (bar_index - lastSigBar) >= min_bars
    lw2 := w2b
    lastSigBar := bar_index
    array.push(sigB, w2b)
    array.push(sigE, w2e)
    array.push(sigTP, w2tp)
    array.push(sigSL, w2sl)
    array.push(sigR, 0)
    total += 1
    
    if show_labels
        lbl = "ğŸ¯ W3\nR:R " + str.tostring(w2rr, "#.#")
        label.new(w2b, w2e, lbl, style=label.style_label_up, color=color.new(#00ff88, 0), textcolor=color.white, size=size.normal)
        line.new(w2b, w2tp, bar_index + 15, w2tp, color=color.new(color.lime, 20), width=2)
        line.new(w2b, w2sl, bar_index + 15, w2sl, color=color.new(color.red, 20), width=2)

// Wave 4 Signal
var int lw4 = 0
if w4s and w4b != lw4 and (bar_index - lastSigBar) >= min_bars
    lw4 := w4b
    lastSigBar := bar_index
    array.push(sigB, w4b)
    array.push(sigE, w4e)
    array.push(sigTP, w4tp)
    array.push(sigSL, w4sl)
    array.push(sigR, 0)
    total += 1
    
    if show_labels
        lbl = "ğŸ¯ W5\nR:R " + str.tostring(w4rr, "#.#")
        label.new(w4b, w4e, lbl, style=label.style_label_up, color=color.new(#00ccff, 0), textcolor=color.white, size=size.normal)
        line.new(w4b, w4tp, bar_index + 15, w4tp, color=color.new(color.aqua, 20), width=2)
        line.new(w4b, w4sl, bar_index + 15, w4sl, color=color.new(color.red, 20), width=2)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BACKTEST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if array.size(sigR) > 0
    for i = 0 to array.size(sigR) - 1
        if array.get(sigR, i) == 0
            if high >= array.get(sigTP, i)
                array.set(sigR, i, 1)
                wins += 1
            else if low <= array.get(sigSL, i)
                array.set(sigR, i, -1)
                losses += 1

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ZIGZAG DRAW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if show_zz and array.size(zzP) >= 2 and barstate.islast
    for i = 0 to math.min(array.size(zzP) - 2, 15)
        idx = array.size(zzP) - 1 - i
        if idx > 0
            b1 = array.get(zzB, idx-1)
            b2 = array.get(zzB, idx)
            if bar_index - b1 < 500
                col = array.get(zzT, idx) == 1 ? color.lime : color.red
                line.new(b1, array.get(zzP, idx-1), b2, array.get(zzP, idx), color=col, width=3)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATS TABLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if show_stats
    var table tbl = table.new(position.top_right, 2, 8, bgcolor=color.new(#0d1117, 5), border_width=2, border_color=#30363d)
    
    closed = wins + losses
    rate = closed > 0 ? (wins * 100.0 / closed) : 0.0
    openT = total - closed
    
    rateCol = rate >= 80 ? #00ff88 : rate >= 60 ? color.yellow : color.red
    rateBg = rate >= 80 ? color.new(#00ff88, 80) : rate >= 60 ? color.new(color.yellow, 80) : color.new(color.red, 80)
    
    table.cell(tbl, 0, 0, "âš¡ ULTRA MODE", text_color=#00ff88, text_size=size.normal, bgcolor=color.new(#238636, 50))
    table.cell(tbl, 1, 0, timeframe.period, text_color=color.yellow, text_size=size.normal, bgcolor=color.new(#238636, 50))
    
    table.cell(tbl, 0, 1, "Signals", text_color=color.white, text_size=size.small)
    table.cell(tbl, 1, 1, str.tostring(total), text_color=color.white, text_size=size.small)
    
    table.cell(tbl, 0, 2, "âœ… Wins", text_color=#00ff88, text_size=size.small)
    table.cell(tbl, 1, 2, str.tostring(wins), text_color=#00ff88, text_size=size.small)
    
    table.cell(tbl, 0, 3, "âŒ Losses", text_color=#ff6b6b, text_size=size.small)
    table.cell(tbl, 1, 3, str.tostring(losses), text_color=#ff6b6b, text_size=size.small)
    
    table.cell(tbl, 0, 4, "â³ Open", text_color=color.orange, text_size=size.small)
    table.cell(tbl, 1, 4, str.tostring(openT), text_color=color.orange, text_size=size.small)
    
    table.cell(tbl, 0, 5, "ğŸ† WIN RATE", text_color=color.white, text_size=size.normal, bgcolor=rateBg)
    table.cell(tbl, 1, 5, str.tostring(rate, "#.#") + "%", text_color=rateCol, text_size=size.large, bgcolor=rateBg)
    
    // Confirmations status
    confTxt = (use_trend ? "EMA " : "") + (use_rsi ? "RSI " : "") + (use_momentum ? "MOM" : "")
    table.cell(tbl, 0, 6, "Filters", text_color=color.gray, text_size=size.tiny)
    table.cell(tbl, 1, 6, confTxt, text_color=color.gray, text_size=size.tiny)
    
    trendTxt = uptrend ? "ğŸŸ¢ UP" : "ğŸ”´ DOWN"
    table.cell(tbl, 0, 7, "Trend", text_color=color.white, text_size=size.small)
    table.cell(tbl, 1, 7, trendTxt, text_color=uptrend ? #00ff88 : #ff6b6b, text_size=size.small)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ALERTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

alertcondition(w2s, "ULTRA W3", "âš¡ ULTRA: Wave 3 Entry!")
alertcondition(w4s, "ULTRA W5", "âš¡ ULTRA: Wave 5 Entry!")
